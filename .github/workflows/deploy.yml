name: Deploy

on:
  pull_request:
    branches:
      - main
      
jobs:
  quality-assurance:
    name: Quality Assurance
    runs-on: ubuntu-latest
    container: python:3.12-slim

    services:
      db:
          image: postgres:16.2
          env:
              POSTGRES_DB: ${{ secrets.POSTGRES_NAME }}
              POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
              POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

          options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          ports:
              - 5432:5432

      nginx:
          image: nginx
          # Map port 8080 on the Docker host to port 80 on the nginx container
          ports:
              - 8080:80
      redis:
          image: redis
          # Map TCP port 6379 on Docker host to a random free port on the Redis container
          ports:
              - 6379/tcp

    steps:
      - uses: actions/checkout@v2

      - name: Install Dependencies
        run: | 
              python -m pip install --upgrade pip 
              pip install -r requirements.txt

      - name: Django testing
        run: python manage.py test
        env:
            POSTGRES_NAME: ${{ secrets.POSTGRES_NAME }}
            POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
            SECRET_KEY: ${{ secrets.FAKE_SECRET_KEY }}
    #   - name: Lint
    #     run: |
    #         flake8

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          docker-compose -f docker-compose.yml build
          docker-compose -f docker-compose.yml push

      - name: Deploy containers
        run: |
          docker-compose -f docker-compose.yml up -d



